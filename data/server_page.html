<!DOCTYPE html>
<html lang="es">

<head>
  <title>Configuración del Reloj</title>
  <meta charset="UTF-8">
  <style>
    .color-static {
      display: none;
    }

    .timer-activated {
      display: none;
    }

    .countdown-activated {
      display: none;
    }

    .set-time {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Configuración del Reloj</h1>
  <!-- Slider de velocidad -->
  <h2>Velocidad</h2>
  <input type='range' min='1' max='100' value='1' id='velocitySlider'>
  <button onclick='setVelocity()'>Enviar</button>
  <div id='velocityValue'>1</div>

  <!-- modo de color -->
  <label for="colorModeSelector">
    <h2>Modo de color</h2>
  </label>
  <select id="colorModeSelector" onchange="setColorMode()">
    <option value="0">Color Estático</option>
    <option value="1">Arcoíris</option>
    <option value="2">Flujo</option>
  </select>

  <div class="color-static">
    <input type='range' min='0' max='255' value='1' id='colorSlider' onchange="setColor()">
    <div id='colorVisualizer' style='width: 30px; height: 30px; display: inline-block; border: 1px solid #000;'></div>
    <div id='colorValue'>1</div>
  </div>

  <!-- slider brillo -->
  <h2>Brillo</h2>
  <input type='range' min='1' max='100' value='1' id='brightSlider' oninput='setBright()'>
  <div id='brightValue'>1</div>
  <label for='autoBrightnessCheckbox'>Brillo Automático</label>
  <input type='checkbox' id='autoBrightnessCheckbox' onchange='toggleAutoBrightness()'>

  <p></p>
  <p style="display: inline-block;">Brillo Actual en la habitación: <span id="currentBrightness"
      style="margin-left: 10px;">-</span></p>

  <!-- modo del reloj -->
  <label for="timerModeSelector">
    <h2>Modo del reloj</h2>
  </label>
  <select id="timerModeSelector" onchange="setTimerMode()">
    <option value="0">Reloj</option>
    <option value="1">Cronómetro</option>
    <option value="2">Temporizador</option>
  </select>

  <div class="timer-activated">
    <br>
    <div class="countdown-activated">
      <input type='number' min='0' max='99' value='0' id='countdownMinutes'> :
      <input type='number' min='0' max='59' value='0' id='countdownSeconds'>
      <button onclick='setCountdown()'>Enviar</button>
    </div>

    <button onclick='startPauseTimer()' id="startPauseTimerButton">Cambiar</button>
    <button onclick='stopTimer()'>Parar</button>
    
  </div>
  
  <!-- Selector hora offline -->
  <div class="set-time">
    <br>
    <label for="hour">Hora offline: </label>
    <input type='number' min='0' max='23' value='0' id='hour'> :
    <input type='number' min='0' max='59' value='0' id='minute'>
    <button onclick='settime()'>Enviar</button>
  </div>


  <!-- Selector de hora de inicio -->
  <h2>Modo nocturno</h2>
  <input type='number' min='0' max='23' value='0' id='startHour'> :
  <input type='number' min='0' max='59' value='0' id='startMinute'> -
  <input type='number' min='0' max='23' value='0' id='endHour'> :
  <input type='number' min='0' max='59' value='0' id='endMinute'>
  <button onclick='setNightTime()'>Enviar</button>
  <label for='nightTimeEnabledCheckbox'>Modo nocturno habilitado</label>
  <input type='checkbox' id='nightTimeEnabledCheckbox' onchange='toggleNightTimeEnabled()'>

  <!-- Configuración de WiFi -->
  <h2>Configuración de WiFi</h2>
  <label for="wifiSSID">SSID:</label>
  <input type="text" id="wifiSSID"> <br>
  <label for="wifiPassword">Contraseña:</label>
  <input type="password" id="wifiPassword"> <br>
  <button onclick="setWifiConfig()">Conectar WiFi</button>

  <br><br>

  <div>
  <!-- Botón de alternancia para invertir dígitos -->
  <button onclick='toggleInvertedDigits()'>Invertir Dígitos</button>

  <!-- Reiniciar memoria -->
  <button onclick='resetDefault()'>Reset memory</button>

  <!-- Reiniciar WiFi -->
  <button onclick='resetWifi()'>Reset WiFi</button>
  </div>

  <script>
    var invertedValue, startPauseTimerValue;
    var velocitySlider = document.getElementById('velocitySlider');
    var velocityValue = document.getElementById('velocityValue');
    var colorModeSelector = document.getElementById("colorModeSelector");
    var colorSlider = document.getElementById('colorSlider');
    var colorValue = document.getElementById('colorValue');
    var colorVisualizer = document.getElementById('colorVisualizer');
    var brightSlider = document.getElementById('brightSlider');
    var brightValue = document.getElementById('brightValue');
    var autoBrightnessCheckbox = document.getElementById('autoBrightnessCheckbox');

    var timerModeSelector = document.getElementById("timerModeSelector");
    var countdownMinutes = document.getElementById('countdownMinutes');
    var countdownSeconds = document.getElementById('countdownSeconds');

    var hour = document.getElementById('hour');
    var minute = document.getElementById('minute');

    var nightTimeEnabledCheckbox = document.getElementById('nightTimeEnabledCheckbox');
    var startHour = document.getElementById('startHour');
    var startMinute = document.getElementById('startMinute');
    var endHour = document.getElementById('endHour');
    var endMinute = document.getElementById('endMinute');

    var wifiSSID = document.getElementById('wifiSSID');
    var wifiPassword = document.getElementById('wifiPassword');

    velocitySlider.oninput = function () { velocityValue.innerHTML = this.value; };

    function setVelocity() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/velocity?velocity=' + velocitySlider.value, true);
      xhr.send();
    }

    function setColorMode() {
      var colorStaticGroup = document.querySelector('.color-static');

      if (colorModeSelector.value === '0') {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/config', true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var config = JSON.parse(xhr.responseText);

            var color = parseInt(config.color);
            colorSlider.value = color;
            updateColorVisualizer(color);
            colorValue.textContent = color;
            colorStaticGroup.style.display = 'block';
          }
        };
        xhr.send();
      } else {
        colorStaticGroup.style.display = 'none';
      }

      var xhr2 = new XMLHttpRequest();
      xhr2.open('GET', '/colormode?mode=' + colorModeSelector.value, true);
      xhr2.send();
    }

    colorSlider.oninput = function () {
      colorValue.innerHTML = this.value;
      updateColorVisualizer(this.value);
    };

    function setColor() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/color?color=' + colorSlider.value, true);
      xhr.send();
    }

    function updateColorVisualizer(color) {
      colorVisualizer.style.backgroundColor = 'hsl(' + color * 1.41 + ', 100%, 50%)';
    }

    function settime() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/settime?hour=' + hour + '&min=' + minute, true);
      xhr.send();
    }

    function setNightTime() {
      var xhr = new XMLHttpRequest();
      var url = '/nighttime?0=' + startHour.value + '&1=' + startMinute.value + '&2=' + endHour.value + '&3=' + endMinute.value;
      xhr.open('GET', url, true);
      xhr.send();
    }

    function toggleNightTimeEnabled() {
      var status = nightTimeEnabledCheckbox.checked ? 1 : 0;

      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/nighttimeenabled?status=' + status, true);
      xhr.send();
    }

    function toggleInvertedDigits() {
      var xhr = new XMLHttpRequest();
      invertedValue = invertedValue === 1 ? 0 : 1;
      xhr.open('GET', '/inverteddigits?useInvertedDigits=' + invertedValue, true);
      xhr.send();
    }

    var lastBrightValue = brightSlider.value;
    var brightSend = true;

    function setBright() {
      var value = brightSlider.value;
      brightValue.innerHTML = value;

      if (value != lastBrightValue && brightSend) {
        setTimeout(function () { sendBright(); }, 150);
        brightSend = false;
      }
    }

    function sendBright() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/brightness?brightness=' + brightSlider.value, true);
      xhr.send();
      lastSentValue = brightSlider.value;
      brightSend = true;
    }

    function toggleAutoBrightness() {
      var status = autoBrightnessCheckbox.checked ? 1 : 0;

      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/autobrightness?status=' + status, true);
      xhr.send();
    }

    function getRoomBrightness() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/getbrightness', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var brightnessValue = JSON.parse(xhr.responseText).brightness;
          document.getElementById('currentBrightness').textContent = brightnessValue;
        }
      };
      xhr.send();
    }

    function setTimerMode() {
      var timerActivatedGroup = document.querySelector('.timer-activated');
      var setTimeGroup = document.querySelector('.set-time');

      if (timerModeSelector.value === '0') {
        timerActivatedGroup.style.display = 'none';
        setTimeGroup.style.display = 'block';
      } else {
        setTimeGroup.style.display = 'none';
        timerActivatedGroup.style.display = 'block';
        document.querySelector('.countdown-activated').style.display = timerModeSelector.value === '2' ? 'block' : 'none';
      }

      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/timermode?mode=' + timerModeSelector.value, true);
      xhr.send();
    }

    function startPauseTimer() {
      var xhr = new XMLHttpRequest();
      startPauseTimerValue = startPauseTimerValue === 1 ? 0 : 1;

      if (startPauseTimerValue == 1)
        xhr.open('GET', '/starttimer', true);
      else
        xhr.open('GET', '/pausetimer', true);

      xhr.send();
      updateStartPauseTimerButtonLabel(startPauseTimerValue);
    }

    function updateStartPauseTimerButtonLabel(value) {
      startPauseTimerButton.innerHTML = value === 1 ? 'Pausar' : 'Iniciar';
    }

    function stopTimer() {
      startPauseTimerValue = 0;
      updateStartPauseTimerButtonLabel(startPauseTimerValue);
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/stoptimer', true);
      xhr.send();
    }

    function setCountdown() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/setcountdown?min=' + countdownMinutes.value + '&sec=' + countdownSeconds.value, true);
      xhr.send();
    }

    function setWifiConfig() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/wifi?ssid=' + wifiSSID.value + '&password=' + wifiPassword.value, true);
      xhr.send();
    }

    function resetDefault() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/resetdefault', true);
      xhr.send();
    }
    
    function resetWifi() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/resetwifi', true);
      xhr.send();
    }

    function loadConfig() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/config', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var config = JSON.parse(xhr.responseText);

          velocitySlider.value = config.refreshVelocity;
          velocityValue.textContent = config.refreshVelocity;
          invertedValue = parseInt(config.useInvertedDigits);
          colorModeSelector.value = parseInt(config.colorMode);
          document.querySelector('.color-static').style.display = colorModeSelector.value === '0' ? 'block' : 'none';

          var color = parseInt(config.color);
          colorSlider.value = color;
          updateColorVisualizer(color);
          colorValue.textContent = color;

          var brightness = parseInt(config.brightness);
          brightSlider.value = brightness;
          brightValue.textContent = brightness;
          autoBrightnessCheckbox.checked = config.autoBrightness;

          timerModeSelector.value = parseInt(config.timerMode);
          document.querySelector('.set-time').style.display = timerModeSelector.value === '0' ? 'block' : 'none';
          document.querySelector('.timer-activated').style.display = timerModeSelector.value === '0' ? 'none' : 'block';
          document.querySelector('.countdown-activated').style.display = timerModeSelector.value === '2' ? 'block' : 'none';
          countdownMinutes.value = parseInt(config.countdownMinutes);
          countdownSeconds.value = parseInt(config.countdownSeconds);
          isTimerActive = config.isTimerActive;
          updateStartPauseTimerButtonLabel(isTimerActive === true ? 1 : 0);

          nightTimeEnabledCheckbox.checked = config.nightTimeEnabled;
          startHour.value = parseInt(config.nightTimeRange[0]);
          startMinute.value = parseInt(config.nightTimeRange[1]);
          endHour.value = parseInt(config.nightTimeRange[2]);
          endMinute.value = parseInt(config.nightTimeRange[3]);
        }
      };
      xhr.send();
    }

    window.onload = loadConfig;
    // Actualizar cada segundo (1000 milisegundos)
    setInterval(getRoomBrightness, 2500);
  </script>

</body>

</html>